#!/usr/bin/perl


#-------------------------------------------------------------------------------------------------------------------------------
# Submit a GEANT4 simulation job
#
# Inputs
#  --resource               : Computer resource. Default: interactive.
#  --tag                    : Tag for output files.
#  --config-file            : Analysis configuration file from the config/ directory.
#
#  --cpu-time               : Required CPU time. 
#  --job-dir                : Directory for job scripts and outputs. Default: `pwd`.
#  --softw-dir              : code top-level directory. 
# D.Sgalaberna
#-------------------------------------------------------------------------------------------------------------------------------
#


use File::Path;

$iarg=0;
foreach (@ARGV) {

    if($iarg % 2 == 1) {$iarg++; next;}
    
    ##################################### Common ########################################
    if   ($_ eq '--resource'         ) { $resource        = $ARGV[$iarg+1]; }
    elsif($_ eq '--cpu-time'         ) { $cput            = $ARGV[$iarg+1]; }
    elsif($_ eq '--tag'              ) { $tag             = $ARGV[$iarg+1]; }
    elsif($_ eq '--nruns'            ) { $nruns           = $ARGV[$iarg+1]; }
    elsif($_ eq '--config'           ) { $config_file     = $ARGV[$iarg+1]; }
    elsif($_ eq '--vis-file'         ) { $vis_file        = $ARGV[$iarg+1]; }
    elsif($_ eq '--first-exp'        ) { $first_exp       = $ARGV[$iarg+1]; }
    elsif($_ eq '--nexpts'           ) { $nexpts          = $ARGV[$iarg+1]; }
    elsif($_ eq '--job-dir'          ) { $job_dir         = $ARGV[$iarg+1]; }
    elsif($_ eq '--softw-dir'        ) { $softw_dir       = $ARGV[$iarg+1]; }
    elsif($_ eq '--exe-clust-dir'    ) { $exe_clust_dir   = $ARGV[$iarg+1]; }
    elsif($_ eq '--exe-loc-dir'      ) { $exe_loc_dir     = $ARGV[$iarg+1]; }

    else {
	print "Unrecognised argument ".$_."\n"; exit;
    }
    $iarg++;
}

$exe_clust_dir = "bin/cluster/" unless defined $exe_clust_dir; # path starting from $softw_dir
$exe_loc_dir = "bin/" unless defined $exe_loc_dir; # path starting from $softw_dir

$resource        = "interactive"               unless defined $resource;

#$tag             = "g4ND280Up_6E20_classic_1864x600x1300_nue"    unless defined $tag;
#$tag             = "g4ND280Up_6E20_nd280current_numu_0p2T"    unless defined $tag;
#$tag             = "g4ND280Up_6E20_classic_AfterDetUpdate_9_12_16" unless defined $tag;
#$tag             = "g4ND280Up_6E20_classic_ECalAll_1_2_17" unless defined $tag;

#$tag             = "g4ND280Up_6E20_alter_targ_ftpc_ECalAll_28_2_17" unless defined $tag;
#$tag             = "g4ND280Up_6E20_alter_targ_40cm_ftpc_ECalAll_28_2_17" unless defined $tag;
#$tag             = "g4ND280Up_6E20_alter_ftpc_targ_ECalAll_28_2_17" unless defined $tag;
#$tag             = "g4ND280Up_6E20_alter_ftpc_targ_40cm_ECalAll_28_2_17" unless defined $tag;

$tag             = "test" unless defined $tag;


# After update 14/3/17

#$config_file     = "config/configuration_cluster_current.xml" unless defined $config_file; # current: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_current_ecal.xml" unless defined $config_file; # current: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_ref.xml" unless defined $config_file; # reference: no ecal, no tof, cluste
#$config_file     = "config/configuration_cluster_ref_ecal.xml" unless defined $config_file; # reference: no ecal, no tof, cluste
#$config_file     = "config/configuration_cluster_targ_ftpc_2fgd.xml" unless defined $config_file; # alternative targ/ftpc: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_targ_ftpc_2fgd_ecal.xml" unless defined $config_file; # alternative targ/ftpc: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_ftpc_targ_2fgd.xml" unless defined $config_file; # alternative ftpc/targ: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_ftpc_targ_2fgd_ecal.xml" unless defined $config_file; # alternative ftpc/targ: no ecal, no tof, cluster
#$config_file     = "config/configuration_cluster_ref_tof.xml" unless defined $config_file; # reference: no ecal, cluster
$config_file     = "config/configuration_cluster_ref_tof_ecal.xml" unless defined $config_file; # reference: no ecal, cluster




# After updates
#$config_file     = "config/configuration_classic.xml" unless defined $config_file;
#$config_file     = "config/configuration_cluster_classic.xml" unless defined $config_file;
#$config_file     = "config/configuration_classic_ecal.xml" unless defined $config_file;
#$config_file     = "config/configuration_cluster_classic_ecal.xml" unless defined $config_file;
#$config_file     = "config/configuration_current_ecal.xml" unless defined $config_file;
#$config_file     = "config/configuration_cluster_current_ecal.xml" unless defined $config_file;

# Alternative configurations
#$config_file     = "config/Alternative/configuration_targ_ftpc_2fgd_ecal.xml" unless defined $config_file;
#$config_file     = "config/Alternative/configuration_targ_ftpc_2fgd_ecal_40cm.xml" unless defined $config_file;
#$config_file     = "config/Alternative/configuration_ftpc_targ_2fgd_ecal.xml" unless defined $config_file;
#$config_file     = "config/Alternative/configuration_ftpc_targ_2fgd_ecal_40cm.xml" unless defined $config_file;
#$config_file     = "config/Alternative/configuration_cluster_targ_ftpc_2fgd_ecal.xml" unless defined $config_file;
#$config_file     = "config/Alternative/configuration_cluster_targ_ftpc_2fgd_ecal_40cm.xml" unless defined $config_file;   
#$config_file     = "config/Alternative/configuration_cluster_ftpc_targ_2fgd_ecal.xml" unless defined $config_file;       
#$config_file     = "config/Alternative/configuration_cluster_ftpc_targ_2fgd_ecal_40cm.xml" unless defined $config_file;       

# Add ToF detectors
#$config_file     = "config/Test/configuration_classic_ecal_tof.xml" unless defined $config_file;


$vis_file        = "mac/vis.mac"           unless defined $vis_file;
#$vis_file        = "mac/vis_nd280current.mac"           unless defined $vis_file;
#$vis_file        = "mac/vis_cluster.mac"           unless defined $vis_file;
#$vis_file        = "mac/vis_cluster_nd280current.mac"           unless defined $vis_file;

$nruns           = 180                          unless defined $nruns;      # number of jobs (ECal)
#$nruns           = 90                          unless defined $nruns;      # number of jobs (classic)   
#$nexpts          = 10000                        unless defined $nexpts;     # number of events per job  

#$nruns           = 46                          unless defined $nruns;      # number of jobs (classic)
$nexpts          = 5000                        unless defined $nexpts;     # number of events per job

$first_expt      = 0                           unless defined $first_expt; # first event

#$queue           = "veryshort"                unless defined $queue;
$queue           = "short"                unless defined $queue;

$irun = 0;
while($irun < $nruns) { # loop over the jobs
    
    $evt_first = $first_expt + $irun * $nexpts;
    
 
    if($resource eq "interactive") {
	$arguments = "$softw_dir/$exe_loc_dir/EffStudy.exe $softw_dir/src/app/EffStudy/$vis_file $softw_dir/src/app/EffStudy/$config_file $job_dir/$tag-Exp$evt_first-Nexpt$nexpts $evt_first $nexpts";
    }
    else{
	#$arguments = "$softw_dir/$exe_clust_dir/EffStudy_Tof_Test.exe $softw_dir/src/app/EffStudy/$vis_file $softw_dir/src/app/EffStudy/$config_file $job_dir/$tag-Exp$evt_first-Nexpt$nexpts $evt_first $nexpts";
	$arguments = "$softw_dir/$exe_clust_dir/EffStudy.exe $softw_dir/src/app/EffStudy/$vis_file $softw_dir/src/app/EffStudy/$config_file $job_dir/$tag-Exp$evt_first-Nexpt$nexpts $evt_first $nexpts";
    }
    
    $command = "$arguments";
    
    print "\n";
    print "Job $irun \n";
    print "First event: $evt_first \n";
    print "# of events: $nexpts \n";
    print "$command \n";
    print "\n////////////////////////////// \n\n";

    ################################### Submit the job ##################################
    
    #
    # UNIGE (Atlas cluster), $job_dir not used, $tag gives path/name of output file
    #
    if($resource eq "UNIGE-Atlas") {
	$sbatchfile = "$job_dir/$tag-$evt_first-$nexpts.sbatch";
	#open(PBS, ">$job_dir/$tag-$evt_first-$nexpts.sbatch") or die("Can not create the sbatch script");
	open(PBS, ">$sbatchfile") or die("Can not create the sbatch script");
	print PBS "#!/bin/bash -l  \n";
	print PBS "source $softw_dir/T2KND280Up_CLHEP.sh $softw_dir \n";
	print PBS "\n";
	print PBS "env \n";
	print PBS "\n";
	print PBS "uname -n \n";
	print PBS "\n";
	print PBS "$command \n";
	close(PBS);	
	`qsub -q $queue -l mem=6000mb -l vmem=6000mb $sbatchfile`;
	#`qsub -q $queue -l mem=6000mb -l vmem=6000mb $job_dir/g4ND280Up-$evt_first-$nexpts.sbatch`;
	#`qsub -q $queue -l mem=20000mb -l vmem=20000mb $job_dir/g4ND280Up-$evt_first-$nexpts.sbatch`;
    }
    if($resource eq "interactive") {
	system($command);
    }

    $irun=$irun+1;
} # end loop over jobs
